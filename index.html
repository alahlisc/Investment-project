<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>لوحة تحكم المشروع الاستثماري - النادي الأهلي</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #006400;
      --primary-light: #4caf50;
      --secondary-color: #d4af37;
      --accent-color: #0a3d62;
      --light-bg: #f8f9fa;
      --card-bg: #fff;
      --text-color: #2c3e50;
      --text-light: #7f8c8d;
      --success-color: #27ae60;
      --warning-color: #f39c12;
      --danger-color: #e74c3c;
      --info-color: #3498db;
      --purple-color: #9b59b6;
      --border-radius: 10px;
      --box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Cairo', sans-serif;
      background-color: var(--light-bg);
      color: var(--text-color);
      line-height: 1.6;
    }
    
    .container {
      max-width: 1800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
      color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      position: relative;
    }
    
    .notification-badge {
      position: absolute;
      top: 15px;
      left: 15px;
      background-color: var(--danger-color);
      color: white;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8em;
      cursor: pointer;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .logo img {
      height: 70px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    h1 {
      color: white;
      font-size: 1.8em;
      font-weight: 700;
    }
    
    .header-actions {
      display: flex;
      gap: 12px;
    }
    
    .header-btn {
      background-color: rgba(255, 255, 255, 0.15);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: var(--transition);
      font-family: 'Cairo', sans-serif;
      font-weight: 600;
    }
    
    .header-btn:hover {
      background-color: rgba(255, 255, 255, 0.25);
      transform: translateY(-2px);
    }
    
    .nav-tabs {
      display: flex;
      background: white;
      border-radius: var(--border-radius);
      overflow: hidden;
      margin-bottom: 30px;
      box-shadow: var(--box-shadow);
      flex-wrap: wrap;
    }
    
    .nav-tab {
      padding: 16px 20px;
      cursor: pointer;
      background: #f8fafc;
      transition: var(--transition);
      text-align: center;
      flex: 1;
      min-width: 150px;
      font-weight: 600;
      border-bottom: 3px solid transparent;
    }
    
    .nav-tab.active {
      background: white;
      color: var(--primary-color);
      border-bottom: 3px solid var(--primary-color);
    }
    
    .nav-tab:hover:not(.active) {
      background: #eef2f7;
    }
    
    .tab-content {
      display: none;
      animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .tab-content.active {
      display: block;
    }
    
    .section-title {
      font-size: 1.5rem;
      color: var(--accent-color);
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--primary-light);
    }
    
    /* بطاقات الإحصائيات */
    .stats-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .card {
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: var(--box-shadow);
      position: relative;
      overflow: hidden;
      border-top: 4px solid var(--primary-color);
      transition: var(--transition);
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }
    
    .card.success { border-top-color: var(--success-color); }
    .card.warning { border-top-color: var(--warning-color); }
    .card.danger { border-top-color: var(--danger-color); }
    .card.info { border-top-color: var(--info-color); }
    .card.purple { border-top-color: var(--purple-color); }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .card-label {
      color: var(--accent-color);
      font-size: 0.95em;
      font-weight: 600;
    }
    
    .card-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background-color: var(--light-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary-color);
      font-size: 1.2em;
    }
    
    .card-value {
      font-size: 2.2em;
      font-weight: bold;
      color: var(--text-color);
      margin-bottom: 5px;
    }
    
    .card-change {
      font-size: 0.9em;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .card-change.positive { color: var(--success-color); }
    .card-change.negative { color: var(--danger-color); }
    
    /* نظام الواصل المالي */
    .payment-container {
      background: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-bottom: 30px;
    }
    
    .payment-timeline {
      position: relative;
      margin: 20px 0;
      padding-right: 30px;
    }
    
    .payment-timeline::before {
      content: '';
      position: absolute;
      right: 0;
      top: 0;
      width: 2px;
      height: 100%;
      background-color: #ddd;
    }
    
    .payment-event {
      position: relative;
      margin-bottom: 20px;
      padding: 10px 15px;
      background: #f9f9f9;
      border-radius: 5px;
      border-right: 3px solid var(--primary-color);
    }
    
    .payment-event::before {
      content: '';
      position: absolute;
      right: -6px;
      top: 15px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: var(--primary-color);
    }
    
    .payment-date {
      font-weight: 600;
      color: var(--accent-color);
      margin-bottom: 5px;
    }
    
    .payment-details {
      display: flex;
      justify-content: space-between;
    }
    
    .payment-amount {
      font-weight: 600;
      color: var(--success-color);
    }
    
    /* الجداول */
    .table-container {
      background: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-bottom: 30px;
      overflow-x: auto;
    }
    
    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .table-title {
      color: var(--accent-color);
      font-size: 1.2em;
      font-weight: 700;
    }
    
    .table-actions {
      display: flex;
      gap: 15px;
    }
    
    .search-box {
      position: relative;
    }
    
    .search-input {
      padding: 8px 12px;
      padding-left: 35px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-family: 'Cairo', sans-serif;
    }
    
    .search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-light);
    }
    
    .filter-btn {
      background: var(--light-bg);
      border: 1px solid #ddd;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      font-family: 'Cairo', sans-serif;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 12px 15px;
      text-align: right;
      border-bottom: 1px solid #e2e8f0;
    }
    
    th {
      background-color: var(--light-bg);
      color: var(--accent-color);
      font-weight: 700;
    }
    
    tr:hover {
      background-color: #f8fafc;
    }
    
    .invoice-status {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8em;
      font-weight: 600;
    }
    
    .status-paid { background-color: #e8f5e9; color: var(--success-color); }
    .status-pending { background-color: #ffecb3; color: var(--warning-color); }
    .status-overdue { background-color: #ffcdd2; color: var(--danger-color); }
    
    /* طباعة الواصل */
    .receipt {
      display: none;
      background: white;
      padding: 20px;
      border: 2px solid #000;
      max-width: 600px;
      margin: 20px auto;
    }
    
    .receipt-header {
      text-align: center;
      margin-bottom: 20px;
      border-bottom: 2px solid #000;
      padding-bottom: 10px;
    }
    
    .receipt-details {
      margin-bottom: 20px;
    }
    
    .receipt-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    
    .receipt-footer {
      text-align: center;
      margin-top: 30px;
      border-top: 1px dashed #000;
      padding-top: 10px;
    }
    
    /* مؤشر التحميل */
    .loading-indicator {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      flex-direction: column;
    }
    
    .loading-spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--primary-color);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* التجاوب مع أحجام الشاشات */
    @media (max-width: 1200px) {
      .stats-cards {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 992px) {
      header {
        flex-direction: column;
        text-align: center;
        gap: 15px;
      }
      
      .header-actions {
        justify-content: center;
      }
      
      .nav-tabs {
        flex-direction: column;
      }
    }
    
    @media (max-width: 768px) {
      .stats-cards {
        grid-template-columns: 1fr;
      }
      
      .table-actions {
        flex-direction: column;
      }
    }
    
    @media (max-width: 576px) {
      .container {
        padding: 15px;
      }
      
      .card-value {
        font-size: 1.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="loading-indicator" id="loadingIndicator">
    <div class="loading-spinner"></div>
    <p style="margin-top: 20px; font-weight: bold;">جاري تحميل البيانات من GitHub...</p>
  </div>

  <div class="container" style="display: none;" id="mainContent">
    <header>
      <div class="notification-badge" onclick="showNotifications()">3</div>
      <div class="logo">
        <img src="https://upload.wikimedia.org/wikipedia/ar/thumb/5/5e/Al-Ahly_SC_logo.svg/1200px-Al-Ahly_SC_logo.svg.png" alt="شعار النادي الأهلي">
        <h1>لوحة تحكم المشروع الاستثماري - النادي الأهلي</h1>
      </div>
      <div class="header-actions">
        <button class="header-btn" onclick="exportToExcel()">
          <i class="fas fa-download"></i> تصدير Excel
        </button>
        <button class="header-btn" onclick="window.print()">
          <i class="fas fa-print"></i> طباعة
        </button>
        <button class="header-btn" onclick="refreshData()">
          <i class="fas fa-sync-alt"></i> تحديث
        </button>
      </div>
    </header>

    <div class="nav-tabs">
      <div class="nav-tab active" data-tab="dashboard">لوحة التحكم الرئيسية</div>
      <div class="nav-tab" data-tab="shops">إدارة المحلات</div>
      <div class="nav-tab" data-tab="tenants">تصنيف المستأجرين</div>
      <div class="nav-tab" data-tab="payments">الايصال المالي</div>
      <div class="nav-tab" data-tab="prediction">تنبؤ الإيرادات</div>
      <div class="nav-tab" data-tab="annual">الجرد السنوي</div>
    </div>

    <!-- لوحة التحكم الرئيسية -->
    <div class="tab-content active" id="dashboard">
      <h2 class="section-title">نظرة عامة على المشروع</h2>
      
      <div class="stats-cards">
        <div class="card">
          <div class="card-header">
            <div class="card-label">إجمالي المحلات</div>
            <div class="card-icon"><i class="fas fa-store"></i></div>
          </div>
          <div class="card-value" id="totalShops">0</div>
          <div class="card-change">من أصل <span id="totalShopsPlanned">0</span> محل</div>
        </div>
        
        <div class="card success">
          <div class="card-header">
            <div class="card-label">المحلات المستوفية</div>
            <div class="card-icon"><i class="fas fa-check-circle"></i></div>
          </div>
          <div class="card-value" id="completedShops">0</div>
          <div class="card-change positive" id="completedPercentage">0%</div>
        </div>
        
        <div class="card warning">
          <div class="card-header">
            <div class="card-label">المحلات غير المستوفية</div>
            <div class="card-icon"><i class="fas fa-exclamation-triangle"></i></div>
          </div>
          <div class="card-value" id="notCompletedShops">0</div>
          <div class="card-change">تحت المراجعة</div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <div class="card-label">إجمالي الإيرادات</div>
            <div class="card-icon"><i class="fas fa-money-bill-wave"></i></div>
          </div>
          <div class="card-value" id="totalRevenue">0</div>
          <div class="card-change">دينار ليبي</div>
        </div>
        
        <div class="card info">
          <div class="card-header">
            <div class="card-label">متوسط الإيجار الشهري</div>
            <div class="card-icon"><i class="fas fa-chart-bar"></i></div>
          </div>
          <div class="card-value" id="avgRent">0</div>
          <div class="card-change">دينار ليبي</div>
        </div>
        
        <div class="card purple">
          <div class="card-header">
            <div class="card-label">صافي الربح</div>
            <div class="card-icon"><i class="fas fa-chart-line"></i></div>
          </div>
          <div class="card-value" id="netProfit">0</div>
          <div class="card-change positive">دينار ليبي</div>
        </div>
      </div>
      
      <div class="chart-container" style="background: white; padding: 20px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); margin-bottom: 30px;">
        <div class="chart-header">
          <h3 class="table-title">توزيع المحلات حسب حالة الدفع</h3>
        </div>
        <canvas id="paymentChart" height="100"></canvas>
      </div>
    </div>

    <!-- إدارة المحلات -->
    <div class="tab-content" id="shops">
      <h2 class="section-title">إدارة المحلات</h2>
      
      <div class="table-container">
        <div class="table-header">
          <h3 class="table-title">قائمة المحلات</h3>
          <div class="table-actions">
            <div class="search-box">
              <i class="fas fa-search search-icon"></i>
              <input type="text" class="search-input" placeholder="ابحث برقم المحل أو اسم المستأجر..." oninput="filterShopsTable(this.value)">
            </div>
            <button class="filter-btn">
              <i class="fas fa-filter"></i> تصفية
            </button>
          </div>
        </div>
        
        <table class="data-table">
          <thead>
            <tr>
              <th>رقم المحل</th>
              <th>المرحلة</th>
              <th>الدور</th>
              <th>المستأجر</th>
              <th>قيمة الإيجار</th>
              <th>حالة الدفع</th>
              <th>آخر سداد</th>
              <th>الإجراءات</th>
            </tr>
          </thead>
          <tbody id="shopsTableBody">
            <!-- سيتم ملء هذا القسم بالبيانات -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- تصنيف المستأجرين -->
    <div class="tab-content" id="tenants">
      <h2 class="section-title">تصنيف المستأجرين</h2>
      
      <div class="stats-cards">
        <div class="card success">
          <div class="card-header">
            <div class="card-label">المستأجرين المكتملين</div>
            <div class="card-icon"><i class="fas fa-check-circle"></i></div>
          </div>
          <div class="card-value" id="completedTenants">0</div>
          <div class="card-change positive" id="completedTenantsPercentage">0% من إجمالي المستأجرين</div>
        </div>
        
        <div class="card warning">
          <div class="card-header">
            <div class="card-label">المستأجرين غير المكتملين</div>
            <div class="card-icon"><i class="fas fa-exclamation-triangle"></i></div>
          </div>
          <div class="card-value" id="notCompletedTenants">0</div>
          <div class="card-change" id="notCompletedTenantsPercentage">0% من إجمالي المستأجرين</div>
        </div>
        
        <div class="card danger">
          <div class="card-header">
            <div class="card-label">المستأجرين تحت المراجعة</div>
            <div class="card-icon"><i class="fas fa-search"></i></div>
          </div>
          <div class="card-value" id="underReviewTenants">0</div>
          <div class="card-change" id="underReviewTenantsPercentage">0% من إجمالي المستأجرين</div>
        </div>
      </div>
      
      <div class="table-container">
        <div class="table-header">
          <h3 class="table-title">المستأجرين المكتملين</h3>
          <div class="table-actions">
            <div class="search-box">
              <i class="fas fa-search search-icon"></i>
              <input type="text" class="search-input" placeholder="ابحث باسم المستأجر..." oninput="filterTenantsTable(this.value)">
            </div>
            <button class="filter-btn">
              <i class="fas fa-filter"></i> تصفية
            </button>
          </div>
        </div>
        
        <table class="data-table">
          <thead>
            <tr>
              <th>اسم المستأجر</th>
              <th>رقم المحل</th>
              <th>المرحلة</th>
              <th>قيمة الإيجار</th>
              <th>مقدم العقد</th>
              <th>تاريخ بداية العقد</th>
              <th>تاريخ نهاية العقد</th>
              <th>حالة الدفع</th>
              <th>الواصل المالي</th>
            </tr>
          </thead>
          <tbody id="tenantsTableBody">
            <!-- سيتم ملء هذا القسم بالبيانات -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- الواصل المالي -->
    <div class="tab-content" id="payments">
      <h2 class="section-title">الواصل المالي</h2>
      
      <div class="payment-container">
        <h3>السجل المالي للمحل رقم <span id="paymentShopNumber">-</span> - <span id="paymentTenantName">-</span></h3>
        
        <div class="payment-timeline" id="paymentTimeline">
          <!-- سيتم ملء هذا القسم بالبيانات -->
        </div>
        
        <div class="summary-item">
          <span class="summary-label">الإجمالي المدفوع:</span>
          <span class="summary-value" id="totalPaid">0 د.ل</span>
        </div>
        
        <div class="summary-item">
          <span class="summary-label">المتبقي:</span>
          <span class="summary-value" id="remainingAmount">0 د.ل</span>
        </div>
        
        <div class="summary-item">
          <span class="summary-label">حالة الدفع:</span>
          <span class="summary-value" id="paymentStatus"><span class="invoice-status status-pending">غير مكتمل</span></span>
        </div>
        
        <div class="payment-actions" style="margin-top: 20px;">
          <button class="header-btn" onclick="printReceipt()">
            <i class="fas fa-print"></i> طباعة الواصل
          </button>
        </div>
      </div>
    </div>

    <!-- تنبؤ الإيرادات -->
    <div class="tab-content" id="prediction">
      <h2 class="section-title">تنبؤ الإيرادات</h2>
      
      <div class="stats-cards">
        <div class="card">
          <div class="card-header">
            <div class="card-label">الإيراد الشهري الحالي</div>
            <div class="card-icon"><i class="fas fa-money-bill-wave"></i></div>
          </div>
          <div class="card-value" id="currentMonthlyRevenue">0</div>
          <div class="card-change">دينار ليبي</div>
        </div>
        
        <div class="card success">
          <div class="card-header">
            <div class="card-label">الإيراد الشهري المتوقع بعد الزيادة</div>
            <div class="card-icon"><i class="fas fa-chart-line"></i></div>
          </div>
          <div class="card-value" id="predictedMonthlyRevenue">0</div>
          <div class="card-change positive">دينار ليبي</div>
        </div>
        
        <div class="card info">
          <div class="card-header">
            <div class="card-label">الزيادة السنوية المتوقعة</div>
            <div class="card-icon"><i class="fas fa-chart-bar"></i></div>
          </div>
          <div class="card-value" id="predictedYearlyIncrease">0</div>
          <div class="card-change positive">دينار ليبي</div>
        </div>
      </div>
      
      <div class="table-container">
        <div class="table-header">
          <h3 class="table-title">مقارنة الإيرادات قبل وبعد زيادة 100%</h3>
        </div>
        
        <table class="data-table">
          <thead>
            <tr>
              <th>المرحلة</th>
              <th>عدد المحلات</th>
              <th>الإيجار الحالي (شهري)</th>
              <th>الإيجار بعد الزيادة (شهري)</th>
              <th>الفرق</th>
            </tr>
          </thead>
          <tbody id="predictionTableBody">
            <!-- سيتم ملء هذا القسم بالبيانات -->
          </tbody>
        </table>
      </div>
      
      <div class="chart-container" style="background: white; padding: 20px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); margin-top: 20px;">
        <div class="chart-header">
          <h3 class="table-title">مقارنة الإيرادات قبل وبعد الزيادة</h3>
        </div>
        <canvas id="predictionChart" height="100"></canvas>
      </div>
    </div>

    <!-- الجرد السنوي -->
    <div class="tab-content" id="annual">
      <h2 class="section-title">الجرد السنوي</h2>
      
      <div class="stats-cards">
        <div class="card">
          <div class="card-header">
            <div class="card-label">إجمالي الإيرادات السنوية</div>
            <div class="card-icon"><i class="fas fa-money-bill-wave"></i></div>
          </div>
          <div class="card-value" id="yearlyRevenue">0</div>
          <div class="card-change">دينار ليبي</div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <div class="card-label">إجمالي المحلات</div>
            <div class="card-icon"><i class="fas fa-store"></i></div>
          </div>
          <div class="card-value" id="yearlyTotalShops">0</div>
          <div class="card-change">محل</div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <div class="card-label">متوسط الإيجار الشهري</div>
            <div class="card-icon"><i class="fas fa-chart-bar"></i></div>
          </div>
          <div class="card-value" id="yearlyAvgRent">0</div>
          <div class="card-change">دينار ليبي</div>
        </div>
        
        <div class="card success">
          <div class="card-header">
            <div class="card-label">نسبة الإشغال</div>
            <div class="card-icon"><i class="fas fa-chart-pie"></i></div>
          </div>
          <div class="card-value" id="occupancyRate">0%</div>
          <div class="card-change positive" id="occupiedShopsText">0 من 0 محل</div>
        </div>
      </div>
      
      <div class="table-container">
        <div class="table-header">
          <h3 class="table-title">التقرير السنوي <span id="currentYear"></span></h3>
          <div class="table-actions">
            <div class="search-box">
              <i class="fas fa-search search-icon"></i>
              <input type="text" class="search-input" placeholder="ابحث برقم المحل أو اسم المستأجر..." oninput="filterAnnualTable(this.value)">
            </div>
            <button class="filter-btn">
              <i class="fas fa-filter"></i> تصفية
            </button>
          </div>
        </div>
        
        <table class="data-table">
          <thead>
            <tr>
              <th>رقم المحل</th>
              <th>المرحلة</th>
              <th>المستأجر</th>
              <th>الإيجار الشهري</th>
              <th>الإيجار السنوي</th>
              <th>حالة الدفع</th>
              <th>المدفوع</th>
              <th>المتبقي</th>
              <th>الواصل</th>
            </tr>
          </thead>
          <tbody id="annualTableBody">
            <!-- سيتم ملء هذا القسم بالبيانات -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- واصل الطباعة -->
    <div class="receipt" id="receipt">
      <div class="receipt-header">
        <h2>النادي الأهلي - المشروع الاستثماري</h2>
        <p>واصل مالي</p>
      </div>
      
      <div class="receipt-details">
        <div class="receipt-item">
          <span>رقم الواصل:</span>
          <span id="receiptNumber">R-2024001</span>
        </div>
        <div class="receipt-item">
          <span>التاريخ:</span>
          <span id="receiptDate"></span>
        </div>
        <div class="receipt-item">
          <span>اسم المستأجر:</span>
          <span id="receiptTenantName">-</span>
        </div>
        <div class="receipt-item">
          <span>رقم المحل:</span>
          <span id="receiptShopNumber">-</span>
        </div>
        <div class="receipt-item">
          <span>قيمة الإيجار الشهري:</span>
          <span id="receiptRent">0 د.ل</span>
        </div>
        <div class="receipt-item">
          <span>المبلغ المدفوع:</span>
          <span id="receiptAmount">0 د.ل</span>
        </div>
        <div class="receipt-item">
          <span>طريقة الدفع:</span>
          <span>نقدي</span>
        </div>
        <div class="receipt-item">
          <span>الفترة:</span>
          <span id="receiptPeriod">من - إلى -</span>
        </div>
      </div>
      
      <div class="receipt-footer">
        <p>شكراً لتعاملكم معنا</p>
        <p>هذا الواصل ليس بإيصال مالي</p>
      </div>
    </div>
  </div>

  <script>
    // بيانات التطبيق
    let tenantsData = {
      "complete": [],
      "not_completed": [],
      "legal_review": []
    };

    let unreadNotifications = 3;
    let currentTenant = null;
    let allTenantsData = [];

    // تهيئة التطبيق
    document.addEventListener('DOMContentLoaded', function() {
      // إعداد التنقل بين علامات التبويب
      setupTabsNavigation();
      
      // تحديث عدد التنبيهات غير المقروءة
      updateNotificationBadge();
      
      // تعيين السنة الحالية
      document.getElementById('currentYear').textContent = new Date().getFullYear();
      
      // جلب البيانات من GitHub
      fetchDataFromGitHub();
    });

    // جلب البيانات من GitHub باستخدام RawGit CDN
    async function fetchDataFromGitHub() {
      try {
        showLoadingIndicator();
        
        // استخدام RawGit CDN للوصول إلى الملف
        const rawGitUrl = 'https://cdn.jsdelivr.net/gh/alahlisc/Investment-project@main/tenants_data2025.json';
        
        // إضافة timestamp لمنع التخزين المؤقت
        const timestamp = new Date().getTime();
        const urlWithTimestamp = `${rawGitUrl}?t=${timestamp}`;
        
        const response = await fetch(urlWithTimestamp);
        
        if (!response.ok) {
          throw new Error(`فشل في جلب البيانات: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!data || data.length === 0) {
          throw new Error('البيانات المستلمة فارغة أو غير صحيحة');
        }
        
        allTenantsData = data;
        
        // تصنيف البيانات
        classifyTenants(data);
        
        // تحديث الواجهة بالبيانات الجديدة
        updateDashboard(data);
        createCharts();
        updatePredictionData();
        
        hideLoadingIndicator();
        document.getElementById('mainContent').style.display = 'block';
        
        console.log('تم جلب البيانات بنجاح من GitHub:', data.length, 'سجل');
        
      } catch (error) {
        console.error('Error:', error);
        hideLoadingIndicator();
        
        // عرض رسالة الخطأ للمستخدم
        const errorMessage = `حدث خطأ أثناء جلب البيانات: ${error.message}. جاري تحميل بيانات تجريبية...`;
        alert(errorMessage);
        
        // تحميل بيانات تجريبية في حالة فشل جلب البيانات
        loadSampleData();
        document.getElementById('mainContent').style.display = 'block';
      }
    }

    // تحميل بيانات تجريبية
    function loadSampleData() {
      const sampleData = [
        {
          "Unnamed: 0": 1,
          "المستاجر ": "محمد احمد أبو شعالة",
          "المرحلة": 1,
          "الدور": 0,
          "رقم المحل": 1,
          "الايجار": 1500,
          "مقدم العقد": 60000,
          "Unnamed: 7": 20000,
          "تاريخ اخر سداد": "2024-12-02",
          "الباقي": 0,
          "تاريخ بداية العقد": "2021-06-01",
          "تاريخ نهاية العقد": "2041-05-31",
          "ملاحظات": "مستوفي مع تعديل العقد",
          "القيمة المدفوعة ": 60000,
          "رقم الايصال": 1143,
          "اتباث الهوية": 393715,
          "رقم االهاتف": ""
        },
        {
          "Unnamed: 0": 2,
          "المستاجر ": "عبد الوهاب محمد",
          "المرحلة": 1,
          "الدور": 0,
          "رقم المحل": 2,
          "الايجار": 1500,
          "مقدم العقد": 60000,
          "Unnamed: 7": 20000,
          "تاريخ اخر سداد": "2025-02-28",
          "الباقي": 0,
          "تاريخ بداية العقد": "2021-06-01",
          "تاريخ نهاية العقد": "2041-05-31",
          "ملاحظات": "مستوفي دافع حتي سنة 2025",
          "القيمة المدفوعة ": 60000,
          "رقم الايصال": 1108,
          "اتباث الهوية": 420396,
          "رقم االهاتف": 913186304
        },
        {
          "Unnamed: 0": 3,
          "المستاجر ": "بهاء الدين محمد جاد الله",
          "المرحلة": 1,
          "الدور": 0,
          "رقم المحل": 3,
          "الايجار": 1500,
          "مقدم العقد": 60000,
          "Unnamed: 7": 20000,
          "تاريخ اخر سداد": "2024-12-31",
          "الباقي": 0,
          "تاريخ بداية العقد": "2021-06-01",
          "تاريخ نهاية العقد": "2041-05-31",
          "ملاحظات": "مستوفي مع تعديل العقد",
          "القيمة المدفوعة ": 60000,
          "رقم الايصال": 1144,
          "اتباث الهوية": "cfyznlk2",
          "رقم االهاتf": ""
        },
        {
          "Unnamed: 0": 4,
          "المستاجر ": "معز المنير محمد التريكي",
          "المرحلة": 1,
          "الدور": 0,
          "رقم المحل": 4,
          "الايجار": 1500,
          "مقدم العقد": 60000,
          "Unnamed: 7": 20000,
          "تاريخ اخر سداد": "2024-12-31",
          "الباقi": 0,
          "تاريخ بداية العقد": "2021-06-01",
          "تاريخ نهاية العقد": "2041-05-31",
          "ملاحظات": "مستوفي مع تعديل العقد",
          "القيمة المدفوعة ": 60000,
          "رقم الايصال": 1145,
          "اتباث الهوية": 412345,
          "رقم االهاتف": "912345678"
        },
        {
          "Unnamed: 0": 5,
          "المستاجر ": "حسين ابوبكر العزابي",
          "المرحلة": 1,
          "الدور": 0,
          "رقم المحل": 6,
          "الايجار": 1500,
          "مقدم العقد": 60000,
          "Unnamed: 7": 20000,
          "تاريخ اخر سداد": "2024-12-31",
          "الباقي": 30000,
          "تاريخ بداية العقد": "2021-06-01",
          "تاريخ نهاية العقد": "2041-05-31",
          "ملاحظات": "غير مكتمل الدفع",
          "القيمة المدفوعة ": 30000,
          "رقم الايصال": 1146,
          "اتباث الهوية": 423456,
          "رقم االهاتف": "923456789"
        }
      ];
      
      allTenantsData = sampleData;
      classifyTenants(sampleData);
      updateDashboard(sampleData);
      createCharts();
      updatePredictionData();
      
      console.log('تم تحميل البيانات التجريبية:', sampleData.length, 'سجل');
    }

    // عرض مؤشر التحميل
    function showLoadingIndicator() {
      document.getElementById('loadingIndicator').style.display = 'flex';
    }

    // إخفاء مؤشر التحميل
    function hideLoadingIndicator() {
      document.getElementById('loadingIndicator').style.display = 'none';
    }

    // تصنيف المستأجرين بناءً على حالتهم
    function classifyTenants(data) {
      tenantsData = {
        "complete": [],
        "not_completed": [],
        "legal_review": []
      };

      data.forEach(tenant => {
        // تحويل القيم الفارغة إلى 0
        const paidAmount = parseFloat(tenant['القيمة المدفوعة '] || 0);
        const contractAdvance = parseFloat(tenant['مقدم العقد'] || 0);
        
        // حساب المبلغ المتبقي
        const remaining = contractAdvance - paidAmount;
        
        // تصنيف المستأجرين بناءً على حالة الدفع
        if (remaining <= 0) {
          tenantsData.complete.push(tenant);
        } else if (remaining > 0 && remaining < contractAdvance) {
          tenantsData.not_completed.push(tenant);
        } else {
          tenantsData.legal_review.push(tenant);
        }
      });
    }

    // تحديث لوحة التحكم بالبيانات الجديدة
    function updateDashboard(data) {
      // حساب الإحصائيات
      const totalShops = data.length;
      const completedShops = tenantsData.complete.length;
      const notCompletedShops = tenantsData.not_completed.length;
      const underReviewShops = tenantsData.legal_review.length;
      const completedPercentage = totalShops > 0 ? Math.round((completedShops / totalShops) * 100) : 0;
      
      // حساب الإيرادات
      let totalRevenue = 0;
      let totalPaid = 0;
      
      data.forEach(tenant => {
        const rent = parseFloat(tenant['الايجار'] || 0);
        const paid = parseFloat(tenant['القيمة المدفوعة '] || 0);
        
        totalRevenue += rent;
        totalPaid += paid;
      });
      
      const avgRent = totalShops > 0 ? Math.round(totalRevenue / totalShops) : 0;
      const netProfit = Math.round(totalPaid * 0.8); // افتراض صافي ربح 80%
      
      // تحديث بطاقات الإحصائيات
      document.getElementById('totalShops').textContent = totalShops;
      document.getElementById('totalShopsPlanned').textContent = Math.max(80, totalShops); // إذا كان العدد أقل من 80 نعرض 80
      document.getElementById('completedShops').textContent = completedShops;
      document.getElementById('completedPercentage').textContent = `${completedPercentage}%`;
      document.getElementById('notCompletedShops').textContent = notCompletedShops;
      document.getElementById('totalRevenue').textContent = totalRevenue.toLocaleString();
      document.getElementById('avgRent').textContent = avgRent.toLocaleString();
      document.getElementById('netProfit').textContent = netProfit.toLocaleString();
      
      // تحديث إحصائيات المستأجرين
      const totalTenants = totalShops;
      const completedTenantsPercentage = totalTenants > 0 ? Math.round((completedShops / totalTenants) * 100) : 0;
      const notCompletedTenantsPercentage = totalTenants > 0 ? Math.round((notCompletedShops / totalTenants) * 100) : 0;
      const underReviewTenantsPercentage = totalTenants > 0 ? Math.round((underReviewShops / totalTenants) * 100) : 0;
      
      document.getElementById('completedTenants').textContent = completedShops;
      document.getElementById('completedTenantsPercentage').textContent = `${completedTenantsPercentage}% من إجمالي المستأجرين`;
      document.getElementById('notCompletedTenants').textContent = notCompletedShops;
      document.getElementById('notCompletedTenantsPercentage').textContent = `${notCompletedTenantsPercentage}% من إجمالي المستأجرين`;
      document.getElementById('underReviewTenants').textContent = underReviewShops;
      document.getElementById('underReviewTenantsPercentage').textContent = `${underReviewTenantsPercentage}% من إجمالي المستأجرين`;
      
      // تحديث إحصائيات الجرد السنوي
      const yearlyRevenue = totalRevenue * 12;
      const occupiedShops = totalShops;
      const occupancyRate = Math.round((occupiedShops / 80) * 100);
      
      document.getElementById('yearlyRevenue').textContent = yearlyRevenue.toLocaleString();
      document.getElementById('yearlyTotalShops').textContent = totalShops;
      document.getElementById('yearlyAvgRent').textContent = avgRent.toLocaleString();
      document.getElementById('occupancyRate').textContent = `${occupancyRate}%`;
      document.getElementById('occupiedShopsText').textContent = `${occupiedShops} من 80 محل`;
      
      // تحديث جداول البيانات
      updateShopsTable(data);
      updateTenantsTable();
      updateAnnualReportTable(data);
    }

    // تحديث جدول المحلات
    function updateShopsTable(data) {
      const tableBody = document.getElementById('shopsTableBody');
      if (!tableBody) return;
      
      tableBody.innerHTML = '';
      
      data.forEach(tenant => {
        const row = document.createElement('tr');
        
        // تحديد حالة الدفع
        let statusClass = 'status-pending';
        let statusText = 'غير مكتمل';
        
        const paidAmount = parseFloat(tenant['القيمة المدفوعة '] || 0);
        const contractAdvance = parseFloat(tenant['مقدم العقد'] || 0);
        
        if (paidAmount >= contractAdvance) {
          statusClass = 'status-paid';
          statusText = 'مكتمل';
        } else if (paidAmount === 0) {
          statusClass = 'status-overdue';
          statusText = 'متأخر';
        }
        
        row.innerHTML = `
          <td>${tenant['رقم المحل'] || ''}</td>
          <td>المرحلة ${tenant['المرحلة'] || ''}</td>
          <td>${getFloorName(tenant['الدور'])}</td>
          <td>${tenant['المستاجر '] || ''}</td>
          <td>${parseFloat(tenant['الايجار'] || 0).toLocaleString()} د.ل</td>
          <td><span class="invoice-status ${statusClass}">${statusText}</span></td>
          <td>${tenant['تاريخ اخر سداد'] || 'غير متوفر'}</td>
          <td><button class="btn-view" onclick="showPaymentDetails(${tenant['رقم المحل']})">عرض الواصل</button></td>
        `;
        
        tableBody.appendChild(row);
      });
    }

    // تصفية جدول المحلات
    function filterShopsTable(searchTerm) {
      const tableBody = document.getElementById('shopsTableBody');
      const rows = tableBody.getElementsByTagName('tr');
      
      for (let i = 0; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName('td');
        let found = false;
        
        for (let j = 0; j < cells.length; j++) {
          const cellText = cells[j].textContent || cells[j].innerText;
          if (cellText.toLowerCase().includes(searchTerm.toLowerCase())) {
            found = true;
            break;
          }
        }
        
        rows[i].style.display = found ? '' : 'none';
      }
    }

    // تحديث جدول المستأجرين
    function updateTenantsTable() {
      const tableBody = document.getElementById('tenantsTableBody');
      if (!tableBody) return;
      
      tableBody.innerHTML = '';
      
      tenantsData.complete.forEach(tenant => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td>${tenant['المستاجر '] || ''}</td>
          <td>${tenant['رقم المحل'] || ''}</td>
          <td>المرحلة ${tenant['المرحلة'] || ''}</td>
          <td>${parseFloat(tenant['الايجار'] || 0).toLocaleString()} د.ل</td>
          <td>${parseFloat(tenant['مقدم العقد'] || 0).toLocaleString()} د.ل</td>
          <td>${formatDate(tenant['تاريخ بداية العقد'])}</td>
          <td>${formatDate(tenant['تاريخ نهاية العقد'])}</td>
          <td><span class="invoice-status status-paid">مكتمل</span></td>
          <td><button class="btn-view" onclick="showPaymentDetails(${tenant['رقم المحل']})">عرض</button></td>
        `;
        
        tableBody.appendChild(row);
      });
    }

    // تصفية جدول المستأجرين
    function filterTenantsTable(searchTerm) {
      const tableBody = document.getElementById('tenantsTableBody');
      const rows = tableBody.getElementsByTagName('tr');
      
      for (let i = 0; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName('td');
        let found = false;
        
        for (let j = 0; j < cells.length; j++) {
          const cellText = cells[j].textContent || cells[j].innerText;
          if (cellText.toLowerCase().includes(searchTerm.toLowerCase())) {
            found = true;
            break;
          }
        }
        
        rows[i].style.display = found ? '' : 'none';
      }
    }

    // تحديث جدول التقرير السنوي
    function updateAnnualReportTable(data) {
      const tableBody = document.getElementById('annualTableBody');
      if (!tableBody) return;
      
      tableBody.innerHTML = '';
      
      data.forEach(tenant => {
        const monthlyRent = parseFloat(tenant['الايجار'] || 0);
        const yearlyRent = monthlyRent * 12;
        const paidAmount = parseFloat(tenant['القيمة المدفوعة '] || 0);
        const remaining = yearlyRent - paidAmount;
        
        // تحديد حالة الدفع
        let statusClass = 'status-pending';
        let statusText = 'غير مكتمل';
        
        if (paidAmount >= yearlyRent) {
          statusClass = 'status-paid';
          statusText = 'مكتمل';
        } else if (paidAmount === 0) {
          statusClass = 'status-overdue';
          statusText = 'متأخر';
        }
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${tenant['رقم المحل'] || ''}</td>
          <td>المرحلة ${tenant['المرحلة'] || ''}</td>
          <td>${tenant['المستاجر '] || ''}</td>
          <td>${monthlyRent.toLocaleString()} د.ل</td>
          <td>${yearlyRent.toLocaleString()} د.ل</td>
          <td><span class="invoice-status ${statusClass}">${statusText}</span></td>
          <td>${paidAmount.toLocaleString()} د.ل</td>
          <td>${remaining.toLocaleString()} د.ل</td>
          <td><button class="btn-view" onclick="showPaymentDetails(${tenant['رقم المحل']})">عرض</button></td>
        `;
        
        tableBody.appendChild(row);
      });
    }

    // تصفية جدول التقرير السنوي
    function filterAnnualTable(searchTerm) {
      const tableBody = document.getElementById('annualTableBody');
      const rows = tableBody.getElementsByTagName('tr');
      
      for (let i = 0; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName('td');
        let found = false;
        
        for (let j = 0; j < cells.length; j++) {
          const cellText = cells[j].textContent || cells[j].innerText;
          if (cellText.toLowerCase().includes(searchTerm.toLowerCase())) {
            found = true;
            break;
          }
        }
        
        rows[i].style.display = found ? '' : 'none';
      }
    }

    // تحديث بيانات التنبؤ
    function updatePredictionData() {
      // حساب الإيرادات الحالية
      let currentMonthlyRevenue = 0;
      let phase1Shops = 0;
      let phase2Shops = 0;
      
      allTenantsData.forEach(tenant => {
        const rent = parseFloat(tenant['الايجار'] || 0);
        currentMonthlyRevenue += rent;
        
        if (parseInt(tenant['المرحلة']) === 1) {
          phase1Shops++;
        } else if (parseInt(tenant['المرحلة']) === 2) {
          phase2Shops++;
        }
      });
      
      // حساب الإيرادات المتوقعة بعد الزيادة
      const predictedMonthlyRevenue = currentMonthlyRevenue * 2;
      const predictedYearlyIncrease = predictedMonthlyRevenue * 12;
      
      // تحديث البطاقات
      document.getElementById('currentMonthlyRevenue').textContent = currentMonthlyRevenue.toLocaleString();
      document.getElementById('predictedMonthlyRevenue').textContent = predictedMonthlyRevenue.toLocaleString();
      document.getElementById('predictedYearlyIncrease').textContent = predictedYearlyIncrease.toLocaleString();
      
      // تحديث جدول التنبؤ
      const tableBody = document.getElementById('predictionTableBody');
      if (tableBody) {
        tableBody.innerHTML = `
          <tr>
            <td>المرحلة 1</td>
            <td>${phase1Shops}</td>
            <td>${(currentMonthlyRevenue / 2).toLocaleString()} د.ل</td>
            <td>${currentMonthlyRevenue.toLocaleString()} د.ل</td>
            <td style="color: var(--success-color); font-weight: 600;">+${(currentMonthlyRevenue / 2).toLocaleString()} د.ل</td>
          </tr>
          <tr>
            <td>المرحلة 2</td>
            <td>${phase2Shops}</td>
            <td>${(currentMonthlyRevenue / 2).toLocaleString()} د.ل</td>
            <td>${currentMonthlyRevenue.toLocaleString()} د.ل</td>
            <td style="color: var(--success-color); font-weight: 600;">+${(currentMonthlyRevenue / 2).toLocaleString()} د.ل</td>
          </tr>
          <tr>
            <td>المجموع</td>
            <td>${phase1Shops + phase2Shops}</td>
            <td>${currentMonthlyRevenue.toLocaleString()} د.ل</td>
            <td>${predictedMonthlyRevenue.toLocaleString()} د.ل</td>
            <td style="color: var(--success-color); font-weight: 600;">+${currentMonthlyRevenue.toLocaleString()} د.ل</td>
          </tr>
        `;
      }
    }

    // تحويل رقم الدور إلى اسم
    function getFloorName(floorNumber) {
      switch(parseInt(floorNumber)) {
        case 0: return 'الأرضي';
        case 1: return 'الأول';
        case 2: return 'الثاني';
        default: return floorNumber;
      }
    }

    // تنسيق التاريخ
    function formatDate(dateString) {
      if (!dateString) return 'غير محدد';
      
      try {
        const date = new Date(dateString);
        return date.toLocaleDateString('ar-EG');
      } catch (e) {
        return dateString;
      }
    }

    // البحث عن مستأجر برقم المحل
    function findTenantByShopNumber(shopNumber) {
      return allTenantsData.find(tenant => parseInt(tenant['رقم المحل']) === parseInt(shopNumber));
    }

    // إعداد التنقل بين علامات التبويب
    function setupTabsNavigation() {
      const tabs = document.querySelectorAll('.nav-tab');
      
      tabs.forEach(tab => {
        tab.addEventListener('click', function() {
          // إزالة النشاط من جميع علامات التبويب
          tabs.forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          // إضافة النشاط إلى علامة التبويب المحددة
          this.classList.add('active');
          const tabId = this.getAttribute('data-tab');
          const tabContent = document.getElementById(tabId);
          if (tabContent) {
            tabContent.classList.add('active');
          }
        });
      });
    }

    // تحديث عدد التنبيهات
    function updateNotificationBadge() {
      const badge = document.querySelector('.notification-badge');
      if (badge) {
        badge.textContent = unreadNotifications;
      }
    }

    // عرض التنبيهات
    function showNotifications() {
      alert(`لديك ${unreadNotifications} تنبيهات غير مقروءة`);
    }

    // إنشاء الرسوم البيانية
    function createCharts() {
      // رسم بياني لتوزيع المحلات
      const paymentCtx = document.getElementById('paymentChart');
      if (paymentCtx) {
        new Chart(paymentCtx.getContext('2d'), {
          type: 'doughnut',
          data: {
            labels: ['مكتمل', 'غير مكتمل', 'تحت المراجعة'],
            datasets: [{
              data: [tenantsData.complete.length, tenantsData.not_completed.length, tenantsData.legal_review.length],
              backgroundColor: ['#27ae60', '#f39c12', '#e74c3c'],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: 'bottom',
                rtl: true,
                labels: {
                  font: {
                    family: 'Cairo'
                  }
                }
              }
            }
          }
        });
      }
      
      // رسم بياني للتحليلات التنبؤية
      const predictionCtx = document.getElementById('predictionChart');
      if (predictionCtx) {
        // حساب الإيرادات الحالية والمتوقعة
        let currentRevenue = 0;
        allTenantsData.forEach(tenant => {
          currentRevenue += parseFloat(tenant['الايجار'] || 0);
        });
        
        const predictedRevenue = currentRevenue * 2;
        
        new Chart(predictionCtx.getContext('2d'), {
          type: 'bar',
          data: {
            labels: ['الإيرادات الحالية', 'الإيرادات المتوقعة'],
            datasets: [
              {
                label: 'الإيرادات الشهرية',
                data: [currentRevenue, predictedRevenue],
                backgroundColor: ['rgba(0, 100, 0, 0.7)', 'rgba(10, 61, 98, 0.7)'],
              }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: 'bottom',
                rtl: true,
                labels: {
                  font: {
                    family: 'Cairo'
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return value.toLocaleString() + ' د.ل';
                  }
                }
              }
            }
          }
        });
      }
    }

    // عرض تفاصيل الدفع للمستأجر
    function showPaymentDetails(shopNumber) {
      // البحث عن المستأجر برقم المحل
      const tenant = findTenantByShopNumber(shopNumber);
      
      if (!tenant) {
        alert('لم يتم العثور على بيانات المستأجر');
        return;
      }
      
      currentTenant = tenant;
      
      // التبديل إلى تبويب الواصل المالي
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      const paymentsTab = document.querySelector('[data-tab="payments"]');
      const paymentsContent = document.getElementById('payments');
      
      if (paymentsTab && paymentsContent) {
        paymentsTab.classList.add('active');
        paymentsContent.classList.add('active');
      }
      
      // تحديث بيانات الواصل المالي
      document.getElementById('paymentShopNumber').textContent = tenant['رقم المحل'] || '';
      document.getElementById('paymentTenantName').textContent = tenant['المستاجر '] || '';
      
      // إنشاء الجدول الزمني للدفعات
      const timeline = document.getElementById('paymentTimeline');
      if (timeline) {
        timeline.innerHTML = '';
        
        // محاكاة بيانات الدفعات
        const payments = generatePayments(tenant);
        
        payments.forEach(payment => {
          const event = document.createElement('div');
          event.className = 'payment-event';
          event.innerHTML = `
            <div class="payment-date">${payment.date}</div>
            <div class="payment-details">
              <span>${payment.description}</span>
              <span class="payment-amount">${payment.amount.toLocaleString()} د.ل</span>
            </div>
          `;
          timeline.appendChild(event);
        });
        
        // تحديث الإجمالي والمتبقي
        const totalPaid = payments.reduce((sum, payment) => sum + payment.amount, 0);
        const contractAdvance = parseFloat(tenant['مقدم العقد'] || 0);
        const remaining = contractAdvance - totalPaid;
        
        document.getElementById('totalPaid').textContent = `${totalPaid.toLocaleString()} د.ل`;
        document.getElementById('remainingAmount').textContent = `${remaining.toLocaleString()} د.ل`;
        
        // تحديث حالة الدفع
        const statusElement = document.getElementById('paymentStatus');
        if (statusElement) {
          statusElement.innerHTML = remaining <= 0 
            ? '<span class="invoice-status status-paid">مكتمل</span>' 
            : '<span class="invoice-status status-pending">غير مكتمل</span>';
        }
      }
    }

    // توليد بيانات الدفعات (محاكاة)
    function generatePayments(tenant) {
      const payments = [];
      const paidAmount = parseFloat(tenant['القيمة المدفوعة '] || 0);
      const contractAdvance = parseFloat(tenant['مقدم العقد'] || 0);
      const lastPaymentDate = tenant['تاريخ اخر سداد'];
      
      // دفع مقدم العقد (إن وجد)
      if (contractAdvance > 0) {
        payments.push({
          date: formatDate(tenant['تاريخ بداية العقد']) || '2021-06-01',
          amount: contractAdvance,
          description: 'مقدم العقد'
        });
      }
      
      // إذا كان هناك مدفوعات إضافية
      if (paidAmount > contractAdvance) {
        const additionalPayments = paidAmount - contractAdvance;
        payments.push({
          date: formatDate(lastPaymentDate) || '2024-12-31',
          amount: additionalPayments,
          description: 'دفعات إضافية'
        });
      } else if (paidAmount > 0 && paidAmount < contractAdvance) {
        payments.push({
          date: formatDate(lastPaymentDate) || '2024-12-31',
          amount: paidAmount,
          description: 'دفعة جزئية'
        });
      }
      
      return payments;
    }

    // طباعة الواصل
    function printReceipt() {
      if (!currentTenant) {
        alert('لم يتم تحديد مستأجر لطباعة الواصل');
        return;
      }
      
      // تحديث بيانات الواصل
      document.getElementById('receiptTenantName').textContent = currentTenant['المستاجر '] || '';
      document.getElementById('receiptShopNumber').textContent = currentTenant['رقم المحل'] || '';
      
      const rentAmount = parseFloat(currentTenant['الايجار'] || 0);
      document.getElementById('receiptRent').textContent = `${rentAmount.toLocaleString()} د.ل`;
      
      // حساب المبلغ الإجمالي
      const paidAmount = parseFloat(currentTenant['القيمة المدفوعة '] || 0);
      document.getElementById('receiptAmount').textContent = `${paidAmount.toLocaleString()} د.ل`;
      
      // تعيين رقم الواصل عشوائي
      document.getElementById('receiptNumber').textContent = `R-${Math.floor(100000 + Math.random() * 900000)}`;
      
      // تعيين فترة الدفع (محاكاة)
      const startDate = new Date(currentTenant['تاريخ بداية العقد'] || '2021-06-01');
      const endDate = new Date(startDate);
      const monthsPaid = Math.floor(paidAmount / rentAmount);
      endDate.setMonth(startDate.getMonth() + monthsPaid);
      
      document.getElementById('receiptPeriod').textContent = 
        `من ${formatDate(startDate)} إلى ${formatDate(endDate)}`;
      
      // طباعة الواصل
      window.print();
    }

    // تعيين تاريخ اليوم في الواصل
    function setReceiptDate() {
      const now = new Date();
      const formattedDate = now.toLocaleDateString('ar-EG', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      
      const receiptDateEl = document.getElementById('receiptDate');
      if (receiptDateEl) {
        receiptDateEl.textContent = formattedDate;
      }
    }

    // تصدير إلى Excel
    function exportToExcel() {
      if (allTenantsData.length === 0) {
        alert('لا توجد بيانات للتصدير');
        return;
      }
      
      try {
        // إنشاء workbook جديد
        const wb = XLSX.utils.book_new();
        
        // تحويل البيانات إلى worksheet
        const ws = XLSX.utils.json_to_sheet(allTenantsData);
        
        // إضافة worksheet إلى workbook
        XLSX.utils.book_append_sheet(wb, ws, 'بيانات المستأجرين');
        
        // تصدير الملف
        XLSX.writeFile(wb, 'بيانات_المستأجرين.xlsx');
        
        alert('تم تصدير البيانات إلى Excel بنجاح');
      } catch (error) {
        console.error('Error exporting to Excel:', error);
        alert('حدث خطأ أثناء التصدير إلى Excel');
      }
    }

    // تحديث البيانات
    function refreshData() {
      fetchDataFromGitHub();
    }

    // تهيئة تاريخ الواصل عند التحميل
    setReceiptDate();
  </script>
</body>
</html>
